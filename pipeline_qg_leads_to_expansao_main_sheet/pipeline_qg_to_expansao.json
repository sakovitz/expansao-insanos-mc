{
  "files": [
    {
      "id": "a2366e35-612c-4f58-b505-ca4620cf7680",
      "name": "appsscript",
      "type": "json",
      "source": "{\n  \"timeZone\": \"America/Sao_Paulo\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"
    },
    {
      "id": "96d2ea35-c365-4974-8118-dae28ba1444f",
      "name": "Código",
      "type": "server_js",
      "source": "function exportarLeadsParaPlanilhaOficial() {\n  const idInput = \"1VpJy5iZtLAILI9L6XIvjW6VDYE9T36mLnS7GmzFKoUk\";\n  const idOutput = \"1g1QUF_MJGdOuhE4ZYj-rxrY4hyW5vf-DDzbyOwG12r4\";\n  const abaInput = \"leads\"; // ajuste se necessário\n\n  const BATCH_SIZE = 100;\n\n  const ssInput = SpreadsheetApp.openById(idInput);\n  const sheetInput = ssInput.getSheetByName(abaInput);\n  const dataInput = sheetInput.getDataRange().getValues();\n  const ssOutput = SpreadsheetApp.openById(idOutput);\n\n  // mapa DDD -> responsável (fixos)\n  const responsaveis = {\n    \"GONÇALVES\": [82,96,92,97,71,73,74,75,77,85,88,98,99,91,93,94,83,81,87,86,89,84,95,79,63],\n    \"MAGRINI\": [68,65,66,67,31,32,33,34,35,37,38,69],\n    \"HEDER\": [61,62,64,41,42,43,44,45,46,51,53,54,55,47,48,49],\n    \"JHONNY\": [27,28,21,22,24],\n    // ⚠️ DDDs 11–19 serão tratados de forma especial abaixo\n  };\n\n  // grupo que divide SP (11–19)\n  const grupoSP = [\"UNGARO\", \"MURALHA\", \"VICTÃO\", \"JULIÃO\", \"KATCHAU\"];\n  const contadorSP = {}; // usado para distribuir igualmente\n  grupoSP.forEach(nome => contadorSP[nome] = 0);\n\n  // nomes aceitos na coluna \"QUEM PEGOU?\"\n  const nomesValidados = {\n    \"JHONNY\": \"JHONY\",\n    \"UNGARO\": \"UNGARO\",\n    \"GONÇALVES\": \"GONÇALVES\",\n    \"MAGRINI\": \"MAGRINI\",\n    \"HEDER\": \"HEDER\",\n    \"MURALHA\": \"MURALHA\",\n    \"VICTÃO\": \"VICTÃO\",\n    \"JULIÃO\": \"JULIÃO\",\n    \"KATCHAU\": \"KATCHAU\"\n  };\n\n  // helpers\n  function formatarTelefone(num) {\n    if (!num) return \"\";\n    let digits = num.toString().replace(/\\D/g, \"\");\n    if (digits.startsWith(\"55\")) digits = digits.substring(2);\n    if (digits.length === 10) return `55 (${digits.substring(0,2)}) ${digits.substring(2,6)}-${digits.substring(6)}`;\n    if (digits.length === 11) return `55 (${digits.substring(0,2)}) ${digits.substring(2,7)}-${digits.substring(7)}`;\n    return `55 (${digits.substring(0,2)}) ${digits.substring(2)}`;\n  }\n\n  function addDias(dateStr, dias=4) {\n    if (!dateStr) return \"\";\n    const d = new Date(dateStr);\n    d.setDate(d.getDate() + dias);\n    return Utilities.formatDate(d, Session.getScriptTimeZone(), \"dd/MM/yyyy\");\n  }\n\n  function obterUF(ddd) {\n    const mapaUF = {\n      82:\"AL\",96:\"AP\",92:\"AM\",97:\"AM\",71:\"BA\",73:\"BA\",74:\"BA\",75:\"BA\",77:\"BA\",\n      85:\"CE\",88:\"CE\",98:\"MA\",99:\"MA\",91:\"PA\",93:\"PA\",94:\"PA\",83:\"PB\",81:\"PE\",\n      87:\"PE\",86:\"PI\",89:\"PI\",84:\"RN\",95:\"RR\",79:\"SE\",63:\"TO\",68:\"AC\",65:\"MT\",\n      66:\"MT\",67:\"MS\",31:\"MG\",32:\"MG\",33:\"MG\",34:\"MG\",35:\"MG\",37:\"MG\",38:\"MG\",\n      69:\"RO\",61:\"DF\",62:\"GO\",64:\"GO\",41:\"PR\",42:\"PR\",43:\"PR\",44:\"PR\",45:\"PR\",\n      46:\"PR\",51:\"RS\",53:\"RS\",54:\"RS\",55:\"RS\",47:\"SC\",48:\"SC\",49:\"SC\",\n      27:\"ES\",28:\"ES\",21:\"RJ\",22:\"RJ\",24:\"RJ\",12:\"SP\",13:\"SP\",14:\"SP\",15:\"SP\",\n      16:\"SP\",17:\"SP\",18:\"SP\",19:\"SP\",11:\"SP\"\n    };\n    return mapaUF[ddd] || \"\";\n  }\n\n  // colunas\n  const colNome = 0;\n  const colTelefone = 1;\n  const colDDD = 2;\n  const colData = 3;\n  const colNomeWhats = 4;\n  const colRegiao = 5;\n  const colEtiqueta = 6;\n  const colStatus = 7;\n\n  const pendentes = [];\n  for (let i = 1; i < dataInput.length; i++) {\n    const status = dataInput[i][colStatus];\n    if (!status) pendentes.push({i, linha: dataInput[i]});\n    if (pendentes.length >= BATCH_SIZE) break;\n  }\n  if (pendentes.length === 0) {\n    Logger.log(\"⏸ Nenhum registro pendente. Nada a processar.\");\n    return;\n  }\n\n  const rowsBySheet = {};\n  const sheetsCache = {};\n  const dataEnvio = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), \"dd/MM/yyyy\");\n  let totalInseridos = 0;\n\n  for (const item of pendentes) {\n    const i = item.i;\n    const linha = item.linha;\n\n    const nome = linha[colNome] || linha[colNomeWhats] || \"\";\n    const telefone = linha[colTelefone];\n    const ddd = parseInt(linha[colDDD]);\n    const dataInscricao = linha[colData];\n    const regiao = linha[colRegiao];\n    const etiqueta = linha[colEtiqueta];\n    const fonte = (etiqueta && etiqueta.toUpperCase().trim() === \"VINDO DO QG\") ? \"QG\" : \"\";\n\n    let responsavel = null;\n\n    // ⚙️ Se o DDD for entre 11 e 19 → distribuir igualmente entre os 5\n    if (ddd >= 11 && ddd <= 19) {\n      // encontrar quem tem menos leads até agora\n      const proximo = Object.entries(contadorSP).sort((a, b) => a[1] - b[1])[0][0];\n      responsavel = proximo;\n      contadorSP[responsavel]++;\n    } else {\n      // segue mapeamento fixo\n      for (const r in responsaveis) {\n        if (responsaveis[r].includes(ddd)) { responsavel = r; break; }\n      }\n    }\n\n    if (!responsavel) {\n      Logger.log(`⚠️ DDD não mapeado (linha ${i+1}): ${ddd}`);\n      sheetInput.getRange(i+1, colStatus+1).setValue(\"DDD_NAO_MAPEADO\");\n      continue;\n    }\n\n    if (!sheetsCache[responsavel]) {\n      const sh = ssOutput.getSheetByName(responsavel);\n      if (!sh) {\n        Logger.log(`❌ Aba destino não existe: ${responsavel} (linha ${i+1})`);\n        sheetInput.getRange(i+1, colStatus+1).setValue(\"ABA_NAO_ENCONTRADA\");\n        continue;\n      }\n      sheetsCache[responsavel] = sh;\n      rowsBySheet[responsavel] = [];\n    }\n\n    const telefoneFormatado = formatarTelefone(telefone);\n    const prazo = addDias(dataInscricao);\n    const nomeValidado = nomesValidados[responsavel] || responsavel;\n\n    const rowToInsert = [\n      null,                          // A - n°\n      nome,                          // B - NOME\n      telefoneFormatado,             // C - TELEFONE\n      regiao || \"\",                  // D - LOCALIZAÇÃO\n      obterUF(ddd) || \"\",            // E - UF\n      fonte,                         // F - FONTE\n      dataInscricao || \"\",           // G - DATA\n      prazo || \"\",                   // H - PRAZO\n      nomeValidado,                  // I - QUEM PEGOU?\n      \"AINDA NÃO FIZ CONTATO\",       // J - RESULTADO\n      \"A DEFINIR\",                   // K - CMD\n      \"\", \"\", \"\", \"\"                 // L, M, N, O — restantes vazios\n    ];\n\n    rowsBySheet[responsavel].push({row: rowToInsert, inputRowIndex: i});\n  }\n\n  // gravação em bloco\n  for (const responsavel in rowsBySheet) {\n    const entries = rowsBySheet[responsavel];\n    if (!entries.length) continue;\n    const sh = sheetsCache[responsavel];\n    // Acha o último número existente na coluna A\n    const lastNumRange = sh.getRange(\"A:A\").getValues();\n    let lastNum = 0;\n    for (let r = lastNumRange.length - 1; r >= 0; r--) {\n      const val = parseInt(lastNumRange[r][0]);\n      if (!isNaN(val)) { \n        lastNum = val;\n        break;\n      }\n    }\n\n    const firstInsertRow = sh.getLastRow() + 1;\n    const values = entries.map((e, idx) => {\n      const seq = lastNum + idx + 1; // continua a sequência\n      e.row[0] = seq; // coloca o número sequencial\n      return e.row;\n    });\n\n    sh.getRange(firstInsertRow, 1, values.length, values[0].length).setValues(values);\n    totalInseridos += values.length;\n\n    for (const e of entries) {\n      const inputIndex = e.inputRowIndex;\n      sheetInput.getRange(inputIndex + 1, colStatus + 1).setValue(dataEnvio);\n    }\n  }\n\n  Logger.log(`✅ Exportados: ${totalInseridos}. Distribuição SP: ${JSON.stringify(contadorSP)}`);\n}\n"
    }
  ]
}